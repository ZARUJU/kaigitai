# CLI仕様（ドラフト）

## 1. 目的とエントリポイント
- 目的：register→data変換、スキーマ検証、fragment生成を手動CLIで提供
- エントリポイント：リポジトリ直下の `cli.py` を実行するとメニュー（1〜3）を提示
  1) register→data 変換（UUID採番・name解決・検証・出力）
  2) スキーマ検証のみ（register/dataを対象に）
  3) fragment生成（group/personのname enumなどを `docs/schema/fragment/` に自動生成）

## 2. 配置と役割
- `cli.py`：メニュー表示とサブコマンド呼び出し
- `src/cli/commands/convert.py`：register→data変換
- `src/cli/commands/validate.py`：スキーマ検証
- `src/cli/commands/fragment.py`：fragment生成
- `src/core/loader.py`：register/dataの読み込み
- `src/core/resolver.py`：name→UUID解決
- `src/core/validator.py`：JSON Schema検証と参照整合チェック
- `src/core/writer.py`：ファイル出力、差分/ドライラン対応
- `src/utils.py`：共通ユーティリティ（パス操作、ロギング、トリム処理など）
- テストは `tests/` 配下、`uv run pytest` 実行を想定

## 3. パスとスキーマ
- 入出力パスは固定：`register/`（下書き）、`data/`（確定）
- スキーマ配置：`docs/schema/base/`（register用・data用）、`docs/schema/fragment/`（自動生成の参照用）
- VS Code設定例（参考）として `.vscode/settings.json` に `json.schemas` を記述するサンプルを提示するが、CLI仕様の必須要件ではない

## 4. name→UUID 解決方針
- 既存読み込み：`data/group/*.json` と `data/person/*.json` を走査し、name→uuid の辞書を構築（トリム・大文字小文字・全半角の扱いはルール化）
- 解決ルール：
  - nameが1件ヒット：UUIDに置換
  - 0件：モードで挙動を選択（デフォルトは新規UUID発行して追加候補、厳格モードはエラー）
  - 2件以上：重複エラーとして停止
- 変換結果として新規付与・重複エラーをサマリ表示

## 5. バリデーション順序（推奨）
1) register用スキーマ検証（name参照を許容する版）
2) name→UUID解決とID採番
3) data用スキーマ検証（UUIDのみ版）
4) 参照整合チェック（孤児なし、main/sub/attendeeの存在確認）
5) 出力書き込み（`data/`）後に最終スキーマ検証（保険）

## 6. ログ/差分出力
- `--dry-run`：ファイルを書かずにサマリ出力
- 上書き時は差分ダイジェストを表示（before/afterの重要項目）
- サマリ：新規UUID付与、name解決結果、エラー一覧を標準出力に表示

## 7. テスト方針
- コマンドごとに単体テスト、変換フローの結合テストを作成
- 実行は `uv run pytest` を前提とし、失敗出力を受けて修正する運用を想定
